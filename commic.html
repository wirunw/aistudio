<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharm Connection: AI Comic Architect</title>
    <!-- Favicon -->
    <link rel="icon" href="https://i.postimg.cc/yY1rPJ07/wirun_facbook.png" type="image/png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
        }
        h1, h2, h3, h4, button, .font-heading {
            font-family: 'Prompt', sans-serif;
        }
        
        /* SCQA Colors */
        .scqa-s { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; } /* Blue */
        .scqa-c { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; } /* Red */
        .scqa-q { background-color: #fef3c7; color: #92400e; border-color: #fcd34d; } /* Yellow */
        .scqa-a { background-color: #dcfce7; color: #166534; border-color: #86efac; } /* Green */
        
        .panel-card {
            transition: all 0.3s ease;
        }
        .panel-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Aspect Ratio Utilities for Preview */
        .preview-grid-landscape { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        .preview-grid-portrait { display: grid; grid-template-columns: 1fr; gap: 0.5rem; max-width: 200px; margin: 0 auto; }
        .preview-grid-square { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; aspect-ratio: 1/1; }
        .preview-grid-2col { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; max-width: 300px; margin: 0 auto; }
        
        @media (min-width: 768px) {
            .preview-grid-landscape.many-items { grid-template-columns: repeat(3, 1fr); }
        }

        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #10b981; /* Green-500 */
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-family: 'Prompt', sans-serif;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
    </style>
</head>
<body class="text-slate-800 flex flex-col min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-r from-pink-500 to-purple-600 text-white p-2 rounded-lg shadow-md">
                    <img src="https://i.postimg.cc/yY1rPJ07/wirun_facbook.png" class="w-6 h-6 rounded-sm bg-white" alt="Logo">
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight">Pharm Connection <span class="text-pink-600">AI Architect</span></h1>
                    <p class="text-xs text-slate-500">Advanced Comic Prompt Generator v3.0</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="resetForm()" class="text-sm text-slate-500 hover:text-red-500 font-medium px-3 py-1">
                    <i data-lucide="rotate-ccw" class="w-4 h-4 inline mr-1"></i> Reset
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8 flex-grow">

        <!-- Left Column: Settings & Panels (Input) -->
        <div class="lg:col-span-7 space-y-6">
            
            <!-- 1. Global Settings -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex items-center gap-2 mb-4 border-b border-slate-100 pb-2">
                    <div class="bg-blue-100 p-1.5 rounded-md text-blue-600">
                        <i data-lucide="settings-2" class="w-5 h-5"></i>
                    </div>
                    <h2 class="text-lg font-bold text-slate-800">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Global Settings)</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <!-- Layout/Aspect Ratio -->
                     <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á (Layout)</label>
                        <select id="ratioSelect" onchange="updatePreviewLayout()" class="w-full p-2.5 bg-pink-50 border border-pink-200 text-pink-700 font-semibold rounded-lg focus:ring-2 focus:ring-pink-500 outline-none text-sm">
                            <option value="landscape">Landscape (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô 16:9)</option>
                            <option value="portrait">Webtoon (‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏¢‡∏≤‡∏ß 1 ‡πÅ‡∏ñ‡∏ß)</option>
                            <option value="grid_2col">Vertical Grid (2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)</option>
                            <option value="square">Square Grid (‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™ 1:1)</option>
                        </select>
                    </div>

                    <!-- Art Style -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏†‡∏≤‡∏û (Art Style)</label>
                        <select id="styleSelect" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none text-sm">
                            <option value="clean digital illustration, flat color, thick lines, webtoon style">Digital Webtoon (Clean)</option>
                            <option value="Japanese manga style, detailed shading, screentones">Manga (Black & White)</option>
                            <option value="American comic book style, vibrant colors, halftone dots">American Comic</option>
                            <option value="watercolor painting style, soft edges, pastel palette">Watercolor (Soft)</option>
                            <option value="3D Pixar style character render, cute, bright lighting">3D Cute Render</option>
                        </select>
                    </div>

                    <!-- Language (ENABLED) -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">‡∏†‡∏≤‡∏©‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û (Language)</label>
                        <select id="langSelect" class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none text-sm">
                            <option value="Thai">Thai (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)</option>
                            <option value="English">English (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</option>
                            <option value="Japanese">Japanese (‡∏†‡∏≤‡∏©‡∏≤‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô)</option>
                            <option value="No Text">No Text (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)</option>
                        </select>
                    </div>
                </div>

                <!-- Character Definition -->
                <div class="mt-4">
                    <label class="block text-sm font-semibold text-slate-700 mb-1">
                        ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö (Main Character Prototype) 
                        <span class="text-xs font-normal text-slate-500 ml-1">*‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á</span>
                    </label>
                    <textarea id="charDesc" rows="3" class="w-full p-3 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô: A handsome male doctor, wearing glasses, short black hair, wearing a pink blazer over a white shirt, friendly face..."></textarea>
                    <div class="flex gap-2 mt-2 overflow-x-auto pb-2">
                        <span class="text-xs font-bold text-slate-500 self-center">Presets:</span>
                        <button onclick="setChar('doctor_m')" class="text-xs bg-white border border-slate-200 px-2 py-1 rounded hover:bg-slate-50 whitespace-nowrap">‡∏´‡∏°‡∏≠‡∏ä‡∏≤‡∏¢ (‡∏™‡∏π‡∏ó‡∏ä‡∏°‡∏û‡∏π)</button>
                        <button onclick="setChar('doc_f')" class="text-xs bg-white border border-slate-200 px-2 py-1 rounded hover:bg-slate-50 whitespace-nowrap">‡∏´‡∏°‡∏≠‡∏´‡∏ç‡∏¥‡∏á (‡∏ú‡∏°‡∏¢‡∏≤‡∏ß)</button>
                        <button onclick="setChar('pharma_m')" class="text-xs bg-white border border-slate-200 px-2 py-1 rounded hover:bg-slate-50 whitespace-nowrap">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏ä‡∏≤‡∏¢ (‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Å‡∏≤‡∏ß‡∏ô‡πå)</button>
                        <button onclick="setChar('bear_no_glasses')" class="text-xs bg-white border border-slate-200 px-2 py-1 rounded hover:bg-slate-50 whitespace-nowrap">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏´‡∏°‡∏µ (‡πÑ‡∏°‡πà‡πÅ‡∏ß‡πà‡∏ô)</button>
                        <button onclick="setChar('bear_glasses')" class="text-xs bg-white border border-slate-200 px-2 py-1 rounded hover:bg-slate-50 whitespace-nowrap">‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏´‡∏°‡∏µ (‡πÉ‡∏™‡πà‡πÅ‡∏ß‡πà‡∏ô)</button>
                    </div>
                </div>
            </div>

            <!-- 2. Storyboard Editor -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 relative">
                <div class="flex flex-col gap-4 mb-4 border-b border-slate-100 pb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="bg-pink-100 p-1.5 rounded-md text-pink-600">
                                <i data-lucide="layers" class="w-5 h-5"></i>
                            </div>
                            <h2 class="text-lg font-bold text-slate-800">2. ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (Storyboard & SCQA)</h2>
                        </div>
                         <!-- Add Panel Button -->
                         <button onclick="addPanel()" class="bg-slate-800 hover:bg-slate-900 text-white text-sm px-3 py-1.5 rounded-lg flex items-center gap-1 transition shadow-sm">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á
                        </button>
                    </div>

                    <!-- Story Presets Control Panel -->
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        <div class="flex items-center gap-2 text-indigo-800 text-sm font-bold mb-2">
                            <i data-lucide="book-open" class="w-4 h-4"></i>
                            ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Story Generator):
                        </div>
                        
                        <div class="flex flex-col md:flex-row gap-3 items-end">
                            <div class="flex-1 w-full">
                                <label class="text-xs text-indigo-600 font-semibold ml-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏µ‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á:</label>
                                <select id="storyPreset" class="w-full text-sm border-indigo-200 rounded px-2 py-2 text-indigo-900 focus:ring-2 focus:ring-indigo-300 outline-none bg-white">
                                    <option value="consult">1. Consultation (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
                                    <option value="mechanism">2. Mechanism (‡∏Å‡∏•‡πÑ‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏§‡∏ó‡∏ò‡∏¥‡πå)</option>
                                    <option value="myth">3. Myth Buster (‡πÅ‡∏Å‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏¥‡∏î)</option>
                                    <option value="lifestyle">4. Lifestyle Advice (‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°)</option>
                                </select>
                            </div>
                            
                            <div class="w-full md:w-32">
                                <label class="text-xs text-indigo-600 font-semibold ml-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡πà‡∏≠‡∏á:</label>
                                <select id="storyLength" class="w-full text-sm border-indigo-200 rounded px-2 py-2 text-indigo-900 focus:ring-2 focus:ring-indigo-300 outline-none bg-white font-bold text-center">
                                    <option value="3">3 ‡∏ä‡πà‡∏≠‡∏á</option>
                                    <option value="4" selected>4 ‡∏ä‡πà‡∏≠‡∏á</option>
                                    <option value="5">5 ‡∏ä‡πà‡∏≠‡∏á</option>
                                    <option value="6">6 ‡∏ä‡πà‡∏≠‡∏á</option>
                                    <option value="7">7 ‡∏ä‡πà‡∏≠‡∏á</option>
                                    <option value="8">8 ‡∏ä‡πà‡∏≠‡∏á</option>
                                </select>
                            </div>

                            <button onclick="generateStoryFromPreset()" class="w-full md:w-auto bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-indigo-700 flex items-center justify-center gap-1 transition shadow-sm active:scale-95">
                                <i data-lucide="wand-2" class="w-4 h-4"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Panel Container -->
                <div id="panelContainer" class="space-y-4">
                    <!-- Panels will be injected here via JS -->
                </div>
            </div>
        </div>

        <!-- Right Column: Output & Preview -->
        <div class="lg:col-span-5 space-y-6">
            
            <!-- Sticky Container -->
            <div class="sticky top-24 space-y-6">
                
                <!-- Output Card -->
                <div class="bg-slate-900 text-white rounded-xl shadow-lg p-6 border border-slate-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-5 h-5 text-yellow-400"></i>
                            Final Prompt
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="generateFinalPrompt()" class="bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white px-4 py-1.5 rounded-lg text-sm font-semibold transition shadow-lg flex items-center gap-1">
                                <i data-lucide="wand-2" class="w-4 h-4"></i> Generate
                            </button>
                        </div>
                    </div>

                    <!-- Include Dialogue Option -->
                    <div class="flex items-center gap-2 mb-3 bg-slate-800 p-2 rounded border border-slate-700">
                        <input type="checkbox" id="includeDialogue" class="w-4 h-4 text-pink-600 rounded focus:ring-pink-500 border-gray-300" checked>
                        <label for="includeDialogue" class="text-xs text-slate-300 select-none cursor-pointer">
                            ‡πÅ‡∏ô‡∏ö‡∏ö‡∏ó‡∏û‡∏π‡∏î‡πÑ‡∏õ‡πÉ‡∏ô Prompt (Include Dialogue Text)
                        </label>
                    </div>

                    <div class="relative">
                        <textarea id="finalPrompt" rows="12" class="w-full bg-slate-800 text-slate-300 p-4 rounded-lg border border-slate-600 font-mono text-sm leading-relaxed focus:outline-none focus:border-pink-500 resize-none" placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Generate ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt..."></textarea>
                        
                        <button onclick="copyPrompt()" class="absolute top-2 right-2 bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-md transition" title="Copy to Clipboard">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Preview Structure (Visual Guide) -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                            <i data-lucide="layout-grid" class="w-4 h-4"></i> Layout Preview
                        </h3>
                        <span id="previewLabel" class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded">Landscape</span>
                    </div>
                    
                    <div id="layoutPreviewWrapper" class="bg-slate-100 p-4 rounded-lg min-h-[100px] flex justify-center items-start">
                        <div id="layoutPreview" class="w-full">
                            <!-- Dynamic Grid Boxes -->
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- Footer / Credit -->
    <footer class="bg-slate-800 text-slate-400 py-6 border-t border-slate-700">
        <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <p class="font-bold text-slate-200">Pharm Connection AI Architect</p>
                <p class="text-xs mt-1">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏¢‡∏∏‡∏Ñ‡πÉ‡∏´‡∏°‡πà</p>
                <p class="text-xs mt-2 text-slate-500">Developed by Wirun Wetsiri (Pharm Connection)</p>
            </div>
            
            <div class="flex flex-col items-center md:items-end gap-2">
                <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Powered by</span>
                <a href="https://postimg.cc/dDfBQVWf" target="_blank" class="hover:opacity-90 transition-opacity">
                    <img src="https://i.postimg.cc/yY1rPJ07/wirun_facbook.png" alt="wirun_facbook" class="h-10 w-auto rounded bg-white/10 p-1">
                </a>
            </div>
        </div>
    </footer>

    <!-- Toast Notification -->
    <div id="toast"><i data-lucide="check-circle" class="w-5 h-5 inline mr-1"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</div>

    <script>
        // --- Data & State ---
        let panels = []; 

        const charPresets = {
            'doctor_m': 'A handsome Asian male doctor, approx 35 years old, wearing sleek glasses, short neat black hair. He wears a smart pink blazer over a crisp white shirt. Friendly and professional appearance.',
            'doc_f': 'A professional female doctor, long black hair tied in a ponytail, wearing a white medical coat over a blue blouse. Kind eyes, wearing a stethoscope around neck.',
            'pharma_m': 'A young male pharmacist, short hair, wearing a white pharmacist gown with a green cross badge. Standing in a modern pharmacy setting.',
            'bear_no_glasses': 'A cute anthropomorphic bear pharmacist character, white fur, wearing a professional green pharmacist gown. Friendly, soft lighting, 3D render style.',
            'bear_glasses': 'A smart anthropomorphic bear pharmacist character, white fur, wearing round glasses and a professional green pharmacist gown. Holding a clipboard, knowledgeable look.'
        };

        // --- Logic: Dynamic Story Generation ---
        function generateStoryFromPreset() {
            try {
                const theme = document.getElementById('storyPreset').value;
                const length = parseInt(document.getElementById('storyLength').value);
                
                let newPanels = [];
                
                if (theme === 'consult') {
                    newPanels = generateConsultStory(length);
                } else if (theme === 'mechanism') {
                    newPanels = generateMechanismStory(length);
                } else if (theme === 'myth') {
                    newPanels = generateMythStory(length);
                } else if (theme === 'lifestyle') {
                    newPanels = generateLifestyleStory(length);
                }

                // Add IDs
                panels = newPanels.map((p, i) => ({...p, id: Date.now() + i}));
                renderPanels();
                
                // Smart auto-layout hint
                if(length === 4 || length === 6 || length === 8) {
                    if(document.getElementById('ratioSelect').value === 'landscape') {
                        // Keep landscape, user can change manually if needed
                    }
                }
                updatePreviewLayout();
                showToast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! (" + length + " ‡∏ä‡πà‡∏≠‡∏á)");

            } catch (error) {
                console.error("Error generating story:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö");
            }
        }

        // 1. Consultation Theme Generator
        function generateConsultStory(n) {
            let p = [];
            p.push({type:'S', action:'Doctor sitting at desk, smiling warmly at the patient.', text:'‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö?'});
            
            if(n >= 4) p.push({type:'C', action:'Patient holding their stomach/head, expression of pain.', text:'‡∏õ‡∏ß‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤ 2 ‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß'});
            if(n >= 6) p.push({type:'C', action:'Patient explaining more details, looking worried.', text:'‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏Å‡πá‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢ ‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö'});
            if(n >= 8) p.push({type:'Q', action:'Doctor checking pulse or temperature.', text:'‡∏Ç‡∏≠‡∏´‡∏°‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö...'});
            
            p.push({type:'Q', action:'Doctor using a stethoscope or explaining diagnosis.', text:'‡∏´‡∏°‡∏≠‡∏Ç‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏î‡∏π‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö... ‡∏≠‡πã‡∏≠ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å...'});
            
            if(n === 5 || n === 7) p.push({type:'A', action:'Doctor explaining the medicine mechanism briefly.', text:'‡∏¢‡∏≤‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö'});
            
            p.push({type:'A', action:'Doctor handing medication to the patient, explaining usage.', text:'‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ'});
            
            if(n >= 7) p.push({type:'A', action:'Doctor giving additional lifestyle advice.', text:'‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡∏á‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏±‡∏Å‡∏î‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö'});
            if(n >= 3) p.push({type:'A', action:'Patient looking relieved/happy, bowing thank you.', text:'‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏≠ ‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏•‡∏¢'});
            
            return fitToSize(p, n); 
        }

        // 2. Mechanism Theme Generator
         function generateMechanismStory(n) {
            let p = [];
            p.push({type:'S', action:'Zoom in on body part. Cartoon germs/virus looking mean.', text:'‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏õ‡πà‡∏ß‡∏¢!'});
            if(n >= 4) p.push({type:'C', action:'Character looking sick, sweating, suffering.', text:'‡πÇ‡∏≠‡πä‡∏¢‡∏¢ ‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏£‡∏°‡∏≤‡∏ô‡∏à‡∏±‡∏á‡πÄ‡∏•‡∏¢'});
            if(n >= 6) p.push({type:'C', action:'Internal view: Germs attacking healthy cells.', text:'(‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏Ñ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢)'});
            p.push({type:'Q', action:'Doctor introducing the product like a hero item.', text:'‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πà‡∏ß‡∏á! ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏≠‡∏á'});
            if(n >= 5) p.push({type:'A', action:'Microscopic view: The medicine fighting the germs.', text:'(‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏Å‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏Ñ)'});
            if(n >= 7) p.push({type:'A', action:'Microscopic view: Germs being defeated/running away.', text:'(‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÇ‡∏£‡∏Ñ‡πÅ‡∏û‡πâ‡∏û‡πà‡∏≤‡∏¢)'});
            if(n >= 8) p.push({type:'A', action:'Internal view: Cells becoming healthy and pink again.', text:'(‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π)'});
            p.push({type:'A', action:'Character looking fresh, strong, thumbs up.', text:'‡∏´‡∏≤‡∏¢‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö'});
            return fitToSize(p, n);
        }

        // 3. Myth Buster Theme Generator
        function generateMythStory(n) {
            let p = [];
            p.push({type:'S', action:'Person doing something wrong (e.g. taking meds with milk).', text:'‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏°‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏´‡∏•‡∏∞ ‡∏á‡πà‡∏≤‡∏¢‡∏î‡∏µ'});
            p.push({type:'C', action:'Pharmacist runs in with a STOP sign gesture.', text:'‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞!'});
            if(n >= 5) p.push({type:'C', action:'Person looks confused/shocked.', text:'‡∏≠‡πâ‡∏≤‡∏ß ‡∏ó‡∏≥‡πÑ‡∏°‡∏•‡πà‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö? ‡πÉ‡∏Ñ‡∏£‡πÜ ‡πÄ‡∏Ç‡∏≤‡∏Å‡πá‡∏ó‡∏≥‡∏Å‡∏±‡∏ô'});
            p.push({type:'Q', action:'Pharmacist explaining with a diagram (X mark).', text:'‡∏ô‡∏°‡∏à‡∏∞‡πÑ‡∏õ‡∏à‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏¢‡∏≤ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö'});
            if(n >= 6) p.push({type:'Q', action:'Diagram showing the correct way (Water vs Milk).', text:'‡∏î‡∏π‡∏ô‡∏µ‡πà‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡πÅ‡∏Ñ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏°‡πÉ‡∏ô‡∏ô‡∏°‡∏à‡∏∞‡∏Ç‡∏±‡∏î‡∏Ç‡∏ß‡∏≤‡∏á‡∏¢‡∏≤'});
            if(n >= 7) p.push({type:'A', action:'Pharmacist holding a glass of water, smiling.', text:'‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏£‡∏±‡∏ö'});
            if(n >= 8) p.push({type:'A', action:'Pharmacist giving a summary tip.', text:'‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏¥‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏°'});
            p.push({type:'A', action:'Person drinking water instead, nodding approval.', text:'‡∏≠‡πã‡∏≠ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏à‡∏∞‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢!'});
            return fitToSize(p, n);
        }

        // 4. Lifestyle Theme Generator
        function generateLifestyleStory(n) {
            let p = [];
            p.push({type:'S', action:'Character doing bad habit (eating late/working hard).', text:'(‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á)'});
            p.push({type:'C', action:'Character feeling symptoms (pain/dizzy).', text:'‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏î‡∏µ‡πÄ‡∏•‡∏¢... ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏ô‡∏µ‡πà‡∏¢'});
            if(n >= 5) p.push({type:'C', action:'Character trying wrong solution (sleeping it off but failing).', text:'‡∏ô‡∏≠‡∏ô‡∏û‡∏±‡∏Å‡∏Å‡πá‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢ ‡∏ó‡∏≥‡πÑ‡∏á‡∏î‡∏µ'});
            p.push({type:'Q', action:'Doctor pointing to a chart/clock/food.', text:'‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö'});
            if(n >= 6) p.push({type:'A', action:'Visual of "Do This" (Eating veggies/Exercise).', text:'1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå'});
            if(n >= 7) p.push({type:'A', action:'Visual of "Don\'t Do This" (No alcohol/No late night).', text:'2. ‡∏á‡∏î‡∏°‡∏∑‡πâ‡∏≠‡∏î‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå'});
            if(n >= 8) p.push({type:'A', action:'Visual of "Sleep" (Clock showing 10PM).', text:'3. ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤'});
            p.push({type:'A', action:'Character looking healthy and energetic.', text:'‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏•‡∏¢!'});
            return fitToSize(p, n);
        }


        function fitToSize(arr, n) {
            if (arr.length > n) {
                let newArr = arr.slice(0, n-1);
                newArr.push(arr[arr.length-1]);
                return newArr;
            }
            while(arr.length < n) {
                let last = arr[arr.length-1];
                arr.push({...last, text: '...'});
            }
            return arr;
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            document.getElementById('charDesc').value = charPresets['bear_glasses']; 
            panels = generateConsultStory(4).map((p, i) => ({...p, id: Date.now() + i}));
            renderPanels();
            updatePreviewLayout(); 
        });

        // --- Utils ---
        function showToast(message) {
            var x = document.getElementById("toast");
            x.className = "show";
            x.innerText = message;
            if (typeof lucide !== 'undefined') {
                x.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 inline mr-1"></i> ${message}`;
                lucide.createIcons();
            }
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        function renderPanels() {
            const container = document.getElementById('panelContainer');
            container.innerHTML = '';
            
            panels.forEach((panel, index) => {
                const panelHTML = `
                    <div class="panel-card bg-slate-50 border border-slate-200 rounded-lg p-4 relative group">
                        <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition flex gap-1">
                            <button onclick="movePanel(${index}, -1)" class="p-1 hover:bg-slate-200 rounded text-slate-500" ${index === 0 ? 'disabled' : ''}><i data-lucide="arrow-up" class="w-4 h-4"></i></button>
                            <button onclick="movePanel(${index}, 1)" class="p-1 hover:bg-slate-200 rounded text-slate-500" ${index === panels.length - 1 ? 'disabled' : ''}><i data-lucide="arrow-down" class="w-4 h-4"></i></button>
                            <button onclick="deletePanel(${index})" class="p-1 hover:bg-red-100 text-red-500 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        
                        <div class="flex items-center gap-2 mb-3">
                            <span class="bg-slate-800 text-white text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full">${index + 1}</span>
                            <select onchange="updatePanel(${index}, 'type', this.value)" class="text-xs border rounded px-2 py-1 font-semibold outline-none ${getSCQAColorClass(panel.type)}">
                                <option value="S" ${panel.type === 'S' ? 'selected' : ''}>S - Situation</option>
                                <option value="C" ${panel.type === 'C' ? 'selected' : ''}>C - Complication</option>
                                <option value="Q" ${panel.type === 'Q' ? 'selected' : ''}>Q - Question</option>
                                <option value="A" ${panel.type === 'A' ? 'selected' : ''}>A - Answer</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-semibold text-slate-500 uppercase">Visual / Action</label>
                                <textarea oninput="updatePanel(${index}, 'action', this.value)" rows="2" class="w-full text-sm p-2 border border-slate-300 rounded focus:border-pink-500 focus:outline-none" placeholder="‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£...">${panel.action}</textarea>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-slate-500 uppercase flex justify-between">
                                    <span>Speech / Text</span>
                                </label>
                                <textarea oninput="updatePanel(${index}, 'text', this.value)" rows="2" class="w-full text-sm p-2 border border-slate-300 rounded focus:border-blue-500 focus:outline-none" placeholder="‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤...">${panel.text}</textarea>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', panelHTML);
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            renderPreviewBoxes();
        }

        // --- Other functions same as previous, just ensure lucide safety ---
        function updatePreviewLayout() {
            const ratio = document.getElementById('ratioSelect').value;
            const preview = document.getElementById('layoutPreview');
            const label = document.getElementById('previewLabel');
            
            preview.className = ''; 
            
            if (ratio === 'landscape') {
                preview.classList.add('preview-grid-landscape');
                if(panels.length > 4) preview.classList.add('many-items');
                label.innerText = "Landscape (16:9)";
            } else if (ratio === 'portrait') {
                preview.classList.add('preview-grid-portrait');
                label.innerText = "Webtoon Strip (Vertical)";
            } else if (ratio === 'square') {
                preview.classList.add('preview-grid-square');
                label.innerText = "Square (1:1)";
            } else if (ratio === 'grid_2col') {
                const rows = Math.ceil(panels.length / 2);
                label.innerText = `Vertical Grid (2 Cols x ${rows} Rows)`;
                preview.classList.add('preview-grid-2col');
            }
            
            renderPreviewBoxes();
        }

        function renderPreviewBoxes() {
            const preview = document.getElementById('layoutPreview');
            preview.innerHTML = '';
             panels.forEach((panel, index) => {
                 const previewHTML = `
                    <div class="bg-white border border-slate-300 rounded p-2 flex flex-col justify-between shadow-sm relative overflow-hidden h-24 w-full">
                        <div class="absolute top-0 left-0 w-1 h-full ${getSCQABorderClass(panel.type)}"></div>
                        <span class="text-[10px] text-slate-400 font-bold self-end">#${index + 1}</span>
                        <div class="text-[10px] text-slate-600 leading-tight line-clamp-2 text-center italic">"${panel.action.substring(0, 30)}..."</div>
                        <div class="mt-1 bg-slate-100 rounded px-1 py-0.5 text-[9px] text-slate-500 text-center truncate">üí¨ ${panel.text || '...'}</div>
                    </div>
                `;
                preview.insertAdjacentHTML('beforeend', previewHTML);
            });
        }

        function getSCQAColorClass(type) {
            switch(type) {
                case 'S': return 'scqa-s border-blue-200';
                case 'C': return 'scqa-c border-red-200';
                case 'Q': return 'scqa-q border-yellow-200';
                case 'A': return 'scqa-a border-green-200';
                default: return 'bg-slate-100 text-slate-700 border-slate-200';
            }
        }

        function getSCQABorderClass(type) {
            switch(type) {
                case 'S': return 'bg-blue-600';
                case 'C': return 'bg-red-600';
                case 'Q': return 'bg-yellow-500';
                case 'A': return 'bg-green-600';
                default: return 'bg-slate-300';
            }
        }

        function addPanel() {
            let lastType = panels.length > 0 ? panels[panels.length-1].type : 'S';
            let newType = 'S';
            if (lastType === 'S') newType = 'C';
            else if (lastType === 'C') newType = 'Q';
            else if (lastType === 'Q') newType = 'A';
            else if (lastType === 'A') newType = 'A'; 
            panels.push({ id: Date.now(), type: newType, action: '', text: '' });
            renderPanels();
        }

        function deletePanel(index) {
            if (panels.length > 1) {
                panels.splice(index, 1);
                renderPanels();
            } else {
                alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö");
            }
        }

        function movePanel(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < panels.length) {
                [panels[index], panels[newIndex]] = [panels[newIndex], panels[index]];
                renderPanels();
            }
        }

        function updatePanel(index, field, value) {
            panels[index][field] = value;
        }

        function setChar(presetKey) {
            document.getElementById('charDesc').value = charPresets[presetKey];
        }

        function resetForm() {
            if(confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
                panels = [{ id: 1, type: 'S', action: '', text: '' }];
                document.getElementById('charDesc').value = '';
                renderPanels();
            }
        }

        function generateFinalPrompt() {
            const style = document.getElementById('styleSelect').value;
            const charDesc = document.getElementById('charDesc').value.trim() || "A generic character";
            const ratio = document.getElementById('ratioSelect').value;
            const language = document.getElementById('langSelect').value;
            const panelCount = panels.length;
            const includeDialogue = document.getElementById('includeDialogue').checked;
            
            let layout = "";
            if (ratio === 'portrait') {
                 layout = `Vertical strip layout (Webtoon style), 1 column, ${panelCount} panels.`;
            } else if (ratio === 'square') {
                 layout = `Square grid layout, ${panelCount} panels.`;
            } else if (ratio === 'grid_2col') {
                layout = `Grid layout, ${panelCount} panels, clean borders.`; 
            } else {
                layout = `Horizontal comic strip, ${panelCount} panels.`;
            }

            let prompt = `Create a comic. [LAYOUT]: ${layout} [STYLE]: ${style} \n\n`;
            prompt += `[MAIN CHARACTER]: ${charDesc} \n(IMPORTANT: Maintain character consistency in ALL panels).\n\n`;
            
            prompt += `[PANEL DETAILS]:\n`;
            panels.forEach((p, i) => {
                const panelNum = i + 1;
                let moodNote = "";
                if (p.type === 'S') moodNote = " (Mood: Neutral/Everyday Life)";
                if (p.type === 'C') moodNote = " (Mood: Tense/Worried/Problematic)";
                if (p.type === 'Q') moodNote = " (Mood: Realization/Hope/Turning Point)";
                if (p.type === 'A') moodNote = " (Mood: Happy/Relieved/Solution/Bright)";

                prompt += `Panel ${panelNum}: ${p.action}.${moodNote} `;
                
                // --- TOGGLE LOGIC ---
                if (includeDialogue) {
                    prompt += `Speech bubble text (${language}): "${p.text}". `;
                } else {
                    prompt += `Includes an empty speech bubble. `;
                }
                
                prompt += `\n`;
            });

            prompt += `\n[TECHNICAL]: High resolution, consistent character details, clear text rendering.`;
            const outputBox = document.getElementById('finalPrompt');
            outputBox.value = prompt;
            outputBox.classList.add('ring-2', 'ring-pink-500');
            setTimeout(() => outputBox.classList.remove('ring-2', 'ring-pink-500'), 500);
        }

        function copyPrompt() {
            const copyText = document.getElementById("finalPrompt");
            copyText.select();
            document.execCommand("copy");
            alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Prompt ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô nano banana ‡∏´‡∏£‡∏∑‡∏≠ Midjourney ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
        }
    </script>
</body>
</html>